<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<@p.script value=["card", "ztree", "mdcselect", "ztree.combox"] />
<script type="text/javascript" src="${base}/script/jquery.form.js"></script>
<style>
.deviceItem{
	border-bottom:1px solid #ccc;
	padding-bottom:5px;
}
.deviceItem span{
	margin-left:40px;
	width:200px;
}
.deviceItem div{
	margin-top:10px;
}
</style>
<meta charset="utf-8">

<div class="pageheader fix">
	<h2>
		<img src="${base}/themes/default/images/clgl.png" />
		通知管理<span>发布通知信息</span>
	</h2>
</div>

<form id="frm" class="content-bianju">
	<div class="handle-search">
		<!-- 操作列开始 -->
		<div class="handle-div">
			<div class="btn-toolbar">
				<div class="btn-group ml0">
				 	<button id="publishBtn" type="button" class="btn btnGreen">发布通知</button>
				</div>
				<div class="btn-group ml15">
				 	<button id="deleteButton" type="button" class="btn btn-default">删除</button>
				</div>
			</div>
		</div>
		<!-- 操作列开始end -->
		
		<!-- 搜索开始 -->
			<div class="search-div">
				<div class="btn-toolbar">
					<div class="btn-group search-text ml15">
						<input type="text" class="form-control border-radius4" reg="specialchar1" name="search" value="" placeholder="输入标题搜索"/>
			    	</div>
				    <div class="btn-group">
						<button id="search" title="搜索" type="button" class="btn btn-default">搜索</button>
					</div>
				</div>		
			</div>
		<!-- 搜索开始end -->
	</div>
	
	<div class="show-table">
		<table class="pageTable" id="ajaxListData">
			<thead>
				<tr>
					<th style="width:2%;min-width:30px;"><input type="checkbox" name="all" id="checkAll"/></th>
					<th style="width:15%;min-width:82px;"><span>操作</span></th>
					<th style="width:15%;min-width:60px;"><span>标题</span></th>
					<th style="width:30%;min-width:200px;"><span>内容</span></th>
					<th style="width:15%;min-width:60px;"><span>发布结果</span></th>
					<th style="width:20%;min-width:80px;"><span>发布时间</span></th>
				</tr>
			</thead>
			<tbody>
				
			</tbody>
		</table>
	</div>
</form>
<script>
var table = dataTablesWrap({
	basePath:'${base}',
	url:'${base}/baseinfo/notice/list.do',
	data: function(req){
		$("#frm [name]").each(function(i,n){
			req[$(n).attr("name")] = n.value;
		});
	},
	sort:false,
	seq:{show:false},
	columns:[
			{data:'id',  render:function (data, type, full, meta) {
				return "<input type='checkbox' name='id' value='" + full.id +"'/>";
			}},
			{data:'id', render:function (data, type, full, meta) {
            	var result = '<span onClick="deleteStr(' + full.id + ')">删除</span>&nbsp;&nbsp;';
            	result += '<span onClick="getNoticeInfo(' + full.id + ')">变更设备</span>';
            	return result;
            }},
            {data:'title'},
            {data:'content',render:function(data,type,full,meta){
            	return result="<div class='w400 mdc-layer' title='"+data+"'>"+data+"</div>"
            }},
            {data:'result', render:function (data, type, full, meta) {
            	var success;
            	if(full.successCount==null) {
        			full.successCount = 0;
        		}
            	success = full.successCount+"/"+full.totalCount;
            	var result = '<span onClick="sendResult(' + full.id + ')">'+ success +'</span>';
            	return result;
            }},
            {data:'createTime', render:function (data, type, full, meta) {
            	return new Date(data).format("yyyy-MM-dd hh:mm");
            }}
            
      		],
      		onChangePage: function(table) {
      			$("[name='all']:checkbox").prop("checked", false);
      		}
	})
	
	function sendResult(id){
		openDialog({
			title:"查看发布结果",
			width:750,
			height:300,
			padding:"10px",
			ajaxUrl:"${base}/baseinfo/notice/sendResult.do?id="+id,
			ajaxSuccess:function() {
				var resulttable = dataTablesWrap({
					basePath:'${base}',
					url:'${base}/baseinfo/notice/resultList.do',
					displayLength:5,
					data: function(req){
						$("#frm2 [name]").each(function(i,n){
							req[$(n).attr("name")] = n.value;
						});
					},
					sort:false,
					seq:{show:true,index:1},
					columns:[
							{data:'id',  render:function (data, type, full, meta) {
								return "<input type='hidden' name='id' value='" + full.id +"'/>";
							}},
				            {data:'imei'},
				            {data:'name'},
				            {data:'code'},
				            {data:'deptName'},
				            {data:'id',render:function(data, type, full, meta) {
				            	var result;
				            	if(full.resultStatus == 1) {
				            		result = "结果未上报";
				            	}else if(full.resultStatus == 3) {
				            		result = "执行成功";
				            	}else {
				            		result = "执行失败";
				            	}
				            	return result;
				            }}
				      		],
				      		onChangePage: function(table) {
				      			$("[name='all']:checkbox").prop("checked", false);
				      		}
					});
					//搜索
					$("#searchButton").click(function() {
						if($("[name='search2']").val()){
							if(validateForm($("#frm2"))) {
								resulttable.fnDraw();
							}
						}
					});
	
					//回车键搜索
					$("[name='search2']").keypress(function(event) {
						var keyCode = event.keyCode?event.keyCode:event.which?event.which:event.charCode;
						if(keyCode == 13 && validateForm($("#frm2"))) {
							$("#searchButton").trigger('click');
							return false;
						}
					});
					
					$("#refreshBtn").click(function(){
						$("[name='search2']").val("");
						resulttable.fnDraw();
					});
			},
			cancel:null
		
		});
	}
	
	
	//删除通知
	function deleteStr(id) {
		$confirm("确定要删除该通知吗？", function(yes){
			if(yes) {
				waiting = $waiting('操作进行中...');
				$.ajax({
					type: "POST",
					url: "${base}/baseinfo/notice/remove.do",
					data:{id:id},
					success: function(result){
						if(result == "success"){
							$notice('操作成功');	
							waiting.close();
							table.fnDraw();
						}else{
							$notice(result);
							waiting.close();
						}
					},
					error : function(data){
						$notice('操作失败');
						waiting.close();
			  		}
				});
			}
		});
	}
	//删除
	$("#deleteButton").click(function(){
		 var id = getSelectedIds();
		 if(id==null||id.length<1){
			 $alert('请选择要删除的通知');
			 return;
		 }
		 deleteStr(id);
	})
	
		//选择已经被选中 id
	 function getSelectedIds() {
		var arrChk=$("input[name='id']:checkbox");
		var ids;
	    $(arrChk).each(function(){
	    	var self = $(this);
	    	if (self.prop("checked") == true) {
	    		if (ids == null || ids == "") {
	    			ids = self.val();
	    		} else {
		    		ids = ids + "," + self.val();
	    		}
	    	}
	    });
	    return ids;
	 }
	
		$("#search").click(function() {
			if($("[name='search']").val()){
				if(validateForm($("#frm"))) {
					table.fnDraw();
				}
			}
		});
		
		
		$("body").on("click","[name='all']:checkbox",function(){
			if($(this).is(":checked")) {
				$("[name='id']:checkbox").prop("checked", true);
			} else {
				$("[name='id']:checkbox").prop("checked", false);
			}
		});
		$("body").on("click", "[name='id']:checkbox", function(){
			$("[name='all']").prop("checked", $("[name='id']:checkbox:checked").size() >= $("[name='id']:checkbox").size());
		});
		
		$("[name='search']").keypress(function(event) {
			var keyCode = event.keyCode?event.keyCode:event.which?event.which:event.charCode;
			if(keyCode == 13 && validateForm($("#frm"))) {
				$("#search").trigger('click');
				return false;
			}
		});
		
		$("#publishBtn").click(function(){
			openDialog({
				title:"发布通知",
				subtitle:"给客户端发布通知",
				width:650,
				height:300,
				padding:"10px",
				ajaxUrl:"${base}/baseinfo/notice/add.do",
				ok:function(){
					if(!validateForm($("#frmId"))) {
						return false;
					}
					var title = $("#name").val();
					var content = $("#note").val();
					getSendDevice(title, content);
				},
				okVal:"选择人员设备"
				
			});
		});
		
		
		//选择设备弹出框
		function getSendDevice(title, content){
			openDialog({
						title:"发布通知",
						subtitle:"给客户端发布通知",
						width:900,
						height:400,
						padding:"0px",
						ajaxUrl:"${base}/baseinfo/notice/chooseDevice.do",
						ajaxSuccess:function(){
							var deviceTable = dataTablesWrap({
									render:'#ajaxListData1',
									basePath:'${base}',
									displayLength:5,
									data: function(req){
										$("#frm1 [name]").each(function(i,n){
											req[$(n).attr("name")] = n.value;
										});
									},
									url:'${base}/baseinfo/notice/personList.do',
									sort:false,
									seq:{show:false, index:1 },
									columns:[
											{data:'id',  render:function (data, type, full, meta) {
								            	return "<input type='checkbox' name='blackCheck' value='" + full.imei +"'/>";
								            }},
								            {data:'name'},
								            {data:'code'},
								            {data:'deptName'},
								            {data:'brand'},
								            {data:'model'},
								            {data:'imei'}
										],
										//检测页面变化进行去除复选框
										onChangePage: function(blackTable) {
											$("#checkAll").prop("checked", false);
										}
							});
							
							$("#deviceGroupSel").select2({
					            placeholder: "选择设备组",
					            minimumResultsForSearch: Infinity
					        });
					     
					        $("#deviceGroupSel").on("change", function (e) { 
					            $("#deviceGroupId").val($("#deviceGroupSel").select2("val"));
					            deviceTable.fnDraw();
					        });
							
							$("#search1").click(function() {
								if($("[name='search1']").val()){
									if(validateForm($("#frm1"))) {
										deviceTable.fnDraw();
									}
								}
							});
							
							$("[name='search1']").keypress(function(event) {
								var keyCode = event.keyCode?event.keyCode:event.which?event.which:event.charCode;
								if(keyCode == 13 && validateForm($("#frm1"))) {
									$("#search1").trigger('click');
									return false;
								}
							});
							$("#personAssetPublish").click(function(){
								var imeis = getSelectedImeis();
								var msgId = $('#msgId').val();
								if(imeis!=null) {
									$.ajax({
										url: "${base}/baseinfo/notice/addDevice.do",
										type: "post",
										data: {imei:imeis, msgId:msgId, title:title, content:content},
										success: function(result) {
											if(result.success == "true"){
												$('#msgId').val(result.messageId);

												deviceTable.fnDraw();
												table.fnDraw();
												$alert('操作成功，您可以继续发布通知!');
												
											}else{
												$alert(result);
											}
										}
									});
								} else {
									$alert("请选择发布设备");
								}
							});
							
							//选择已经被选中imei
							function getSelectedImeis() {
								var arrChk=$("input[name='blackCheck']:checkbox");
								var ids;
								$(arrChk).each(function(){
									var self = $(this);
									if (self.prop("checked") == true) {
										if (ids == null || ids == "") {
											ids = self.val();
							    		} else {
								    		ids = ids + "," + self.val();
							    		}
							    	}
								});
								return ids;
							}
							
							//选择某个部门下所有的成员 
							$("#departmentPerson").click(function(){
								var deptIds = $("[name='deptId']").val();
								var msgId = $('#msgId').val();
								if(deptIds.length>0) {
									$confirm("确定要发布通知到该部门下？该部门下所有设备将收到该通知， 请谨慎操作", function(yes){
										if(yes) {
											$.ajax({
												url: "${base}/baseinfo/notice/publishDeptDevice.do",
												type: "post",
												data: {deptId:deptIds, msgId:msgId, title:title, content:content},
												success: function(result) {
													if(result.success == "true"){
														$('#msgId').val(result.messageId);

														deviceTable.fnDraw();
														table.fnDraw();
														$alert('操作成功，您可以继续发布通知!');
														
													}else{
														$alert(result.error);
													}
												}
											});
										}
									});
								}else {
									$alert("请选择部门！");
									return false;
								}
							});
							
							setting = {
									basePath: "${base}",
									combox : {
										target:"#deptId",
										trigger:"#selectBtn",
										search:true,
										width:210
									},
									data : {
										simpleData : {
											enable : true,
											idKey : "id",
											pIdKey : "parentId"
											
										}
									},
									view: {
										dblClickExpand: false,
										showIcon: false
									},
									callback: {
										afterSelectNode: function(event, treeId, node) {
											deviceTable.fnDraw();
										},
										afterClear: function() {
											deviceTable.fnDraw();
										},
										afterDropdown: function() {
										 	$("#selectBtn").addClass("open");
										},
										afterDropup: function() {
											$("#selectBtn").removeClass("open");
										}
									}
								};
								var deptTree;
								$(function(){
									deptTree = $.fn.zTree.combox($("#tree"), setting, ${deptJson});
									//全选按钮
									$("#ajaxListData1").on("click","[name='allPerson']:checkbox",function(){
										if($(this).is(":checked")) {
											$("[name='blackCheck']:checkbox").prop("checked", true);
										} else {
											$("[name='blackCheck']:checkbox").prop("checked", false);
										}
									});
									$("#ajaxListData1").on("click", "[name='blackCheck']:checkbox", function(){
										$("[name='allPerson']").prop("checked", $("[name='blackCheck']:checkbox:checked").size() >= $("[name='blackCheck']:checkbox").size());
									}); 
								});
						},
						cancel:null
						
					})
		}
		
		//变更设备弹出框
		function getNoticeInfo(id){
			$.ajax({
				url: "${base}/baseinfo/notice/getNoticeInfo.do",
				type: "post",
				data: {id:id},
				success: function(result) {
					getSendDevice1(result.title, result.content, id);
				}
			});
		}
		
		function getSendDevice1(title, content, msgId){
			openDialog({
						title:"变更设备",
						subtitle:"变更设备继续发布通知",
						width:900,
						height:400,
						padding:"0px",
						ajaxUrl:"${base}/baseinfo/notice/chooseDevice.do",
						ajaxSuccess:function(){
							var deviceTable2 = dataTablesWrap({
									render:'#ajaxListData1',
									basePath:'${base}',
									displayLength:5,
									data: function(req){
										$("#frm1 [name]").each(function(i,n){
											req[$(n).attr("name")] = n.value;
										});
									},
									url:'${base}/baseinfo/notice/personList.do?msgId=' + msgId,
									sort:false,
									seq:{show:false, index:1 },
									columns:[
											{data:'id',  render:function (data, type, full, meta) {
								            	return "<input type='checkbox' name='blackCheck1' value='" + full.imei +"'/>";
								            }},
								            {data:'name'},
								            {data:'code'},
								            {data:'deptName'},
								            {data:'brand'},
								            {data:'model'},
								            {data:'imei'}
										],
										//检测页面变化进行去除复选框
										onChangePage: function(blackTable) {
											$("#checkAll").prop("checked", false);
										}
							});
							
							$("#deviceGroupSel").select2({
					            placeholder: "选择设备组",
					            minimumResultsForSearch: Infinity
					        });
					     
					        $("#deviceGroupSel").on("change", function (e) { 
					            $("#deviceGroupId").val($("#deviceGroupSel").select2("val"));
					            deviceTable2.fnDraw();
					        });
							
							$("#search1").click(function() {
								if($("[name='search1']").val()){
									if(validateForm($("#frm1"))) {
										deviceTable2.fnDraw();
									}
								}
							});
							
							$("[name='search1']").keypress(function(event) {
								var keyCode = event.keyCode?event.keyCode:event.which?event.which:event.charCode;
								if(keyCode == 13 && validateForm($("#frm1"))) {
									$("#search1").trigger('click');
									return false;
								}
							});
							$("#personAssetPublish").click(function(){
								var imeis = getSelectedImeis1();
								if(imeis!=null) {
									$.ajax({
										url: "${base}/baseinfo/notice/addDevice.do",
										type: "post",
										data: {imei:imeis, msgId:msgId, title:title, content:content},
										success: function(result) {
											if(result.success == "true"){

												deviceTable2.fnDraw();
												table.fnDraw();
												$alert('操作成功，您可以继续发布通知!');
												
											}else{
												$alert(result);
											}
										}
									});
								} else {
									$alert("请选择发布设备");
								}
							});
							
							//选择已经被选中imei
							function getSelectedImeis1() {
								var arrChk=$("input[name='blackCheck1']:checkbox");
								var ids;
								$(arrChk).each(function(){
									var self = $(this);
									if (self.prop("checked") == true) {
										if (ids == null || ids == "") {
											ids = self.val();
							    		} else {
								    		ids = ids + "," + self.val();
							    		}
							    	}
								});
								return ids;
							}
							
							//选择某个部门下所有的成员 
							$("#departmentPerson").click(function(){
								var deptIds = $("[name='deptId']").val();
								if(deptIds.length>0) {
									$confirm("确定要发布通知到该部门下？该部门下所有设备将收到该通知， 请谨慎操作", function(yes){
										if(yes) {
											$.ajax({
												url: "${base}/baseinfo/notice/publishDeptDevice.do",
												type: "post",
												data: {deptId:deptIds, msgId:msgId, title:title, content:content},
												success: function(result) {
													if(result.success == "true"){

														deviceTable2.fnDraw();
														table.fnDraw();
														$alert('操作成功，您可以继续发布通知!');
														
													}else{
														$alert(result.error);
													}
												}
											});
										}
									});
								}else {
									$alert("请选择部门！");
									return false;
								}
							});
							
							setting = {
									basePath: "${base}",
									combox : {
										target:"#deptId",
										trigger:"#selectBtn",
										search:true,
										width:210
									},
									data : {
										simpleData : {
											enable : true,
											idKey : "id",
											pIdKey : "parentId"
											
										}
									},
									view: {
										dblClickExpand: false,
										showIcon: false
									},
									callback: {
										afterSelectNode: function(event, treeId, node) {
											deviceTable2.fnDraw();
										},
										afterClear: function() {
											deviceTable2.fnDraw();
										},
										afterDropdown: function() {
										 	$("#selectBtn").addClass("open");
										},
										afterDropup: function() {
											$("#selectBtn").removeClass("open");
										}
									}
								};
								var deptTree;
								$(function(){
									deptTree = $.fn.zTree.combox($("#tree"), setting, ${deptJson});
									//全选按钮
									$("#ajaxListData1").on("click","[name='allPerson']:checkbox",function(){
										if($(this).is(":checked")) {
											$("[name='blackCheck1']:checkbox").prop("checked", true);
										} else {
											$("[name='blackCheck1']:checkbox").prop("checked", false);
										}
									});
									$("#ajaxListData1").on("click", "[name='blackCheck1']:checkbox", function(){
										$("[name='allPerson']").prop("checked", $("[name='blackCheck1']:checkbox:checked").size() >= $("[name='blackCheck1']:checkbox").size());
									}); 
								});
						},
						cancel:null
						
					})
		}
		
</script>

